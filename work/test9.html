<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>报警策略管理系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <!-- 报警规则配置 -->
        <div class="bg-gray-800 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold mb-6">报警规则配置</h2>
            
            <!-- 配置表单 -->
            <form id="ruleForm" class="grid grid-cols-2 gap-6 mb-8">
                <!-- 左侧配置 -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-2">监测参数</label>
                        <select name="parameter" class="w-full bg-gray-700 rounded-lg p-2 focus:ring-2 focus:ring-blue-500">
                            <option value="temperature">温度</option>
                            <option value="co2">CO₂浓度</option>
                            <option value="pressure">压力</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm mb-2">触发条件</label>
                        <select name="condition" class="w-full bg-gray-700 rounded-lg p-2">
                            <option value=">">大于</option>
                            <option value="<">小于</option>
                            <option value="==">等于</option>
                        </select>
                    </div>
                </div>

                <!-- 右侧配置 -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm mb-2">阈值数值</label>
                        <input type="number" name="threshold" 
                               class="w-full bg-gray-700 rounded-lg p-2"
                               placeholder="例如：1000" required>
                    </div>
                    
                    <div>
                        <label class="block text-sm mb-2">报警级别</label>
                        <div class="flex gap-4">
                            <label class="flex items-center">
                                <input type="radio" name="level" value="1" class="mr-2" checked>
                                一级报警
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="level" value="2" class="mr-2">
                                二级报警
                            </label>
                        </div>
                    </div>
                </div>

                <!-- 联动动作配置 -->
                <div class="col-span-2 space-y-4">
                    <h3 class="text-lg font-semibold">联动动作配置</h3>
                    <div class="bg-gray-700 p-4 rounded-lg">
                        <div class="grid grid-cols-3 gap-4 mb-4">
                            <div>
                                <label class="block text-sm mb-2">请求方式</label>
                                <select name="method" class="w-full bg-gray-600 rounded-lg p-2">
                                    <option>GET</option>
                                    <option>POST</option>
                                    <option>PUT</option>
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="block text-sm mb-2">API地址</label>
                                <input type="url" 
                                       class="w-full bg-gray-600 rounded-lg p-2"
                                       placeholder="https://api.example.com/alert" required>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm mb-2">请求头</label>
                            <div class="space-y-2" id="headers">
                                <div class="flex gap-2">
                                    <input type="text" placeholder="Header名称" 
                                           class="bg-gray-600 rounded-lg p-2 flex-1">
                                    <input type="text" placeholder="值" 
                                           class="bg-gray-600 rounded-lg p-2 flex-1">
                                    <button type="button" 
                                            class="bg-gray-500 hover:bg-gray-600 px-3 rounded-lg"
                                            onclick="removeHeader(this)">×</button>
                                </div>
                            </div>
                            <button type="button" 
                                    class="text-blue-400 text-sm mt-2"
                                    onclick="addHeader()">+ 添加请求头</button>
                        </div>

                        <div>
                            <label class="block text-sm mb-2">请求体</label>
                            <textarea class="w-full bg-gray-600 rounded-lg p-2 h-24"
                                      placeholder='{"message": "报警触发"}'></textarea>
                        </div>
                    </div>
                </div>
            </form>

            <!-- 操作按钮 -->
            <div class="flex justify-end gap-4">
                <button type="button" 
                        class="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg"
                        onclick="testApi(this)">测试连接</button>
                <button type="submit" 
                        class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-lg"
                        form="ruleForm">保存规则</button>
            </div>
        </div>

        <!-- 当前生效规则 -->
        <div class="bg-gray-800 rounded-xl p-6 mb-8">
            <h2 class="text-xl font-bold mb-6">当前生效规则</h2>
            <div class="space-y-4" id="ruleList">
                <!-- 规则项动态生成 -->
            </div>
        </div>

        <!-- 报警历史 -->
        <div class="bg-gray-800 rounded-xl p-6">
            <h2 class="text-xl font-bold mb-4">报警历史记录</h2>
            <div class="space-y-2" id="alertHistory">
                <!-- 示例记录 -->
                <div class="bg-gray-700 p-3 rounded-lg">
                    <div class="flex justify-between items-center">
                        <div>
                            <span class="text-sm">2023-12-20 14:30:22</span>
                            <span class="ml-4 px-2 py-1 bg-red-500/20 text-red-400 rounded">CO₂＞1000ppm</span>
                        </div>
                        <span class="text-sm">已触发API调用</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 报警规则数据存储
        let rules = JSON.parse(localStorage.getItem('alertRules') || '[]');
        let editingIndex = -1;

        // 请求头管理
        function addHeader() {
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex gap-2';
            headerDiv.innerHTML = `
                <input type="text" placeholder="Header名称" 
                       class="bg-gray-600 rounded-lg p-2 flex-1">
                <input type="text" placeholder="值" 
                       class="bg-gray-600 rounded-lg p-2 flex-1">
                <button type="button" 
                        class="bg-gray-500 hover:bg-gray-600 px-3 rounded-lg"
                        onclick="removeHeader(this)">×</button>
            `;
            document.getElementById('headers').appendChild(headerDiv);
        }

        function removeHeader(btn) {
            btn.parentElement.remove();
        }

        // 获取当前配置
        function getCurrentConfig() {
            const headers = {};
            Array.from(document.querySelectorAll('#headers div')).forEach(div => {
                const [nameInput, valueInput] = div.querySelectorAll('input');
                if (nameInput.value && valueInput.value) {
                    headers[nameInput.value] = valueInput.value;
                }
            });

            return {
                parameter: document.querySelector('[name="parameter"]').value,
                condition: document.querySelector('[name="condition"]').value,
                threshold: parseFloat(document.querySelector('[name="threshold"]').value),
                level: document.querySelector('[name="level"]:checked').value,
                method: document.querySelector('[name="method"]').value,
                apiUrl: document.querySelector('[type="url"]').value,
                headers: headers,
                body: document.querySelector('textarea').value
            };
        }

        // 保存/更新规则
        document.getElementById('ruleForm').onsubmit = function(e) {
            e.preventDefault();
            const rule = getCurrentConfig();
            
            if (editingIndex > -1) {
                rules[editingIndex] = rule;
                editingIndex = -1;
                addAlertHistory({message: '规则更新成功'});
            } else {
                rules.push(rule);
                addAlertHistory({message: '规则添加成功'});
            }
            
            localStorage.setItem('alertRules', JSON.stringify(rules));
            renderRules();
            this.reset();
        }

        // 渲染规则列表
        function renderRules() {
            const container = document.getElementById('ruleList');
            container.innerHTML = rules.map((rule, index) => `
                <div class="bg-gray-700 p-4 rounded-lg group relative">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-4 mb-2">
                                <span class="px-2 py-1 ${rule.level === '1' ? 'bg-yellow-500/20 text-yellow-400' : 'bg-red-500/20 text-red-400'} rounded">
                                    ${rule.level === '1' ? '一级报警' : '二级报警'}
                                </span>
                                <span class="text-sm text-gray-300">${getParameterName(rule.parameter)}</span>
                            </div>
                            <div class="text-2xl font-mono">
                                ${rule.condition} ${rule.threshold}${getParameterUnit(rule.parameter)}
                            </div>
                        </div>
                        <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button onclick="editRule(${index})" class="text-blue-400 hover:text-blue-300">编辑</button>
                            <button onclick="deleteRule(${index})" class="text-red-400 hover:text-red-300">删除</button>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-600">
                        <div class="flex items-center gap-2 text-sm">
                            <span class="text-gray-400">联动动作:</span>
                            <code class="bg-gray-600 px-2 py-1 rounded">${rule.method} ${rule.apiUrl}</code>
                        </div>
                    </div>
                </div>
            `).join('');

            if(rules.length === 0) {
                container.innerHTML = `<div class="text-center text-gray-500 py-8">暂无生效规则</div>`;
            }
        }

        // 删除规则
        function deleteRule(index) {
            if(confirm('确定要删除此规则吗？')) {
                rules.splice(index, 1);
                localStorage.setItem('alertRules', JSON.stringify(rules));
                renderRules();
                addAlertHistory({message: '规则删除成功'});
            }
        }

        // 编辑规则
        function editRule(index) {
            editingIndex = index;
            const rule = rules[index];
            
            document.querySelector(`[name="parameter"]`).value = rule.parameter;
            document.querySelector(`[name="condition"]`).value = rule.condition;
            document.querySelector(`[name="threshold"]`).value = rule.threshold;
            document.querySelector(`[name="level"][value="${rule.level}"]`).checked = true;
            document.querySelector(`[name="method"]`).value = rule.method;
            document.querySelector(`[type="url"]`).value = rule.apiUrl;
            
            const headerContainer = document.getElementById('headers');
            headerContainer.innerHTML = '';
            Object.entries(rule.headers).forEach(([name, value]) => {
                const div = document.createElement('div');
                div.className = 'flex gap-2';
                div.innerHTML = `
                    <input type="text" value="${name}" class="bg-gray-600 rounded-lg p-2 flex-1">
                    <input type="text" value="${value}" class="bg-gray-600 rounded-lg p-2 flex-1">
                    <button class="bg-gray-500 hover:bg-gray-600 px-3 rounded-lg" onclick="removeHeader(this)">×</button>
                `;
                headerContainer.appendChild(div);
            });

            document.querySelector('textarea').value = rule.body;
            window.scrollTo(0, 0);
        }

        // 辅助函数
        function getParameterName(key) {
            return {
                temperature: '温度',
                co2: 'CO₂浓度',
                pressure: '压力'
            }[key] || '未知参数';
        }

        function getParameterUnit(key) {
            return {
                temperature: '℃',
                co2: 'ppm',
                pressure: 'kPa'
            }[key] || '';
        }

        // 报警历史记录
        function addAlertHistory({status = 'info', message}) {
            const historyItem = document.createElement('div');
            historyItem.className = 'bg-gray-700 p-3 rounded-lg';
            historyItem.innerHTML = `
                <div class="flex justify-between items-center">
                    <div>
                        <span class="text-sm">${new Date().toLocaleString()}</span>
                        <span class="ml-4 px-2 py-1 ${status === 'error' ? 'bg-red-500/20 text-red-400' : 
                            status === 'success' ? 'bg-green-500/20 text-green-400' : 'bg-blue-500/20 text-blue-400'} 
                            rounded">${message}</span>
                    </div>
                </div>
            `;
            document.getElementById('alertHistory').prepend(historyItem);
        }

        // API测试功能
        async function testApi(btn) {
            const config = getCurrentConfig();
            btn.innerHTML = '测试中...';
            
            try {
                const response = await fetch(config.apiUrl, {
                    method: config.method,
                    headers: new Headers(config.headers),
                    body: config.body
                });
                
                addAlertHistory({
                    status: response.ok ? 'success' : 'error',
                    message: `测试响应：${response.status} ${response.statusText}`
                });
            } catch (error) {
                addAlertHistory({
                    status: 'error',
                    message: `连接失败：${error.message}`
                });
            } finally {
                btn.innerHTML = '测试连接';
            }
        }

        // 初始化渲染
        renderRules();
    </script>
</body>
</html>