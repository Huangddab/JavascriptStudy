<!-- 记录类型：化学泄漏（浓度值+物质名称）、空气质量超标（PM2.5/CO等）、设备故障（错误代码+时间戳）。
数据关联：自动绑定抓拍图片、操作者ID及处置备注。
多条件筛选：支持按时间范围、事件类型、处置备注进行筛选。
导出格式：CSV（原始数据）、ZIP（含图片或视频片段）。 -->
<!DOCTYPE html>
<html lang="zh-CN" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>事件记录系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 p-6 transition-colors duration-300">
    <!-- 主题切换按钮 -->
    <div class="absolute top-4 right-4">
        <button id="themeToggle" class="p-2 rounded-full bg-white dark:bg-gray-800 shadow-lg">
            <!-- 保持与之前相同的图标 -->
        </button>
    </div>

    <!-- 筛选区域 -->
    <div class="mb-6 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <input type="datetime-local" id="startTime" class="input-dark">
            <input type="datetime-local" id="endTime" class="input-dark">
            <select id="eventType" class="input-dark">
                <option value="all">所有类型</option>
                <option value="chemical">化学泄漏</option>
                <option value="air">空气质量</option>
                <option value="device">设备故障</option>
            </select>
            <input type="text" id="remarkSearch" placeholder="处置备注搜索" class="input-dark">
        </div>
    </div>

    <!-- 操作栏 -->
    <div class="mb-4 flex justify-between">
        <h2 class="text-2xl font-bold dark:text-white">事件记录</h2>
        <div class="space-x-2">
            <button onclick="exportCSV()" class="btn-dark">导出CSV</button>
            <button onclick="exportZIP()" class="btn-dark">导出ZIP</button>
        </div>
    </div>

    <!-- 数据表格 -->
    <div class="overflow-x-auto rounded-lg shadow">
        <table class="w-full table-dark">
            <thead>
                <tr>
                    <th class="w-24">时间戳</th>
                    <th>事件类型</th>
                    <th>详细数据</th>
                    <th>关联图片</th>
                    <th>操作者</th>
                    <th>处置备注</th>
                    <th class="w-32">操作</th>
                </tr>
            </thead>
            <tbody id="eventTable">
                <!-- 数据通过JS动态生成 -->
            </tbody>
        </table>
    </div>

    <!-- 图片预览模态框 -->
    <div id="imageModal" class="modal-dark hidden">
        <div class="modal-content">
            <span class="close">&times;</span>
            <canvas id="imageCanvas" class="w-full h-full"></canvas>
        </div>
    </div>

<script>
// 模拟数据
let events = [
    {
        type: 'chemical',
        time: '2024-02-20 14:30',
        data: { material: '氯气', concentration: '45ppm' },
        images: ['sample1.jpg'],
        operator: 'user-023',
        remark: '立即启动应急预案'
    },
    {
        type: 'air',
        time: '2024-02-20 15:00',
        data: { type: 'PM2.5', value: '158μg/m³' },
        images: ['sample2.jpg'],
        operator: 'user-045',
        remark: '开启空气净化系统'
    },
    {
        type: 'device',
        time: '2024-02-20 16:15',
        data: { code: 'ERR-504', duration: '2小时' },
        images: ['sample3.jpg'],
        operator: 'user-017',
        remark: '更换传感器模块'
    }
];

// 生成表格行
function renderTable() {
    let tbody = document.getElementById('eventTable');
    tbody.innerHTML = events.map(event => `
        <tr>
            <td>${event.time}</td>
            <td>${getTypeBadge(event.type)}</td>
            <td>${renderEventData(event)}</td>
            <td>
                <div class="grid grid-cols-2 gap-2">
                    ${event.images.map(img => `
                        <img src="${img}" class="thumbnail" 
                             onclick="previewImage('${img}')">
                    `).join('')}
                </div>
            </td>
            <td>${event.operator}</td>
            <td>${event.remark}</td>
            <td>
                <button class="text-blue-500 hover:text-blue-700 dark:text-blue-400">
                    详情
                </button>
            </td>
        </tr>
    `).join('');
}

// 事件类型标签
function getTypeBadge(type) {
    const styles = {
        chemical: 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300',
        air: 'bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300',
        device: 'bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300'
    };
    return `<span class="px-2 py-1 rounded-full text-sm ${styles[type]}">${
        {chemical: '化学泄漏', air: '空气质量', device: '设备故障'}[type]
    }</span>`;
}

// 渲染事件数据
function renderEventData(event) {
    switch(event.type) {
        case 'chemical':
            return `物质：${event.data.material}<br>浓度：${event.data.concentration}`;
        case 'air':
            return `类型：${event.data.type}<br>数值：${event.data.value}`;
        case 'device':
            return `代码：${event.data.code}<br>持续：${event.data.duration}`;
    }
}

// 图片预览
function previewImage(src) {
    const modal = document.getElementById('imageModal');
    const canvas = document.getElementById('imageCanvas');
    const ctx = canvas.getContext('2d');
    
    const img = new Image();
    img.onload = () => {
        canvas.width = img.width;
        canvas.height = img.height;
        ctx.drawImage(img, 0, 0);
        modal.classList.remove('hidden');
    };
    img.src = src;
}

// 导出功能
function exportCSV() {
    const csvContent = "数据,时间,类型,操作者\n" + 
        events.map(e => `${e.data.value},${e.time},${e.type},${e.operator}`).join("\n");
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'events_export.csv';
    link.click();
}

function exportZIP() {
    // 需要实际实现文件打包逻辑
    alert('ZIP导出功能需后端支持');
}

// 初始渲染
renderTable();

// 筛选功能实现
document.querySelectorAll('.input-dark').forEach(input => {
    input.addEventListener('input', () => {
        // 实现筛选逻辑
    });
});

// 暗色模式样式
const style = document.createElement('style');
style.textContent = `
.input-dark {
    @apply bg-gray-50 border border-gray-300 text-gray-900 rounded-lg p-2 
           dark:bg-gray-700 dark:border-gray-600 dark:text-white;
}

.table-dark {
    @apply w-full text-sm text-left text-gray-500 dark:text-gray-400;
}

.table-dark thead {
    @apply bg-gray-100 dark:bg-gray-700;
}

.table-dark th {
    @apply px-4 py-3 font-medium;
}

.table-dark td {
    @apply px-4 py-2 border-t border-gray-200 dark:border-gray-700;
}

.modal-dark {
    @apply fixed top-0 left-0 w-full h-full bg-black bg-opacity-50;
}

.modal-content {
    @apply bg-white dark:bg-gray-800 p-4 rounded-lg mx-auto mt-20 w-3/4;
}

.thumbnail {
    @apply w-16 h-16 object-cover cursor-pointer hover:opacity-75;
}
`;
document.head.appendChild(style);
</script>
</body>
</html>